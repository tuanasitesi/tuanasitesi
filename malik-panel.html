<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Malik Paneli - Tuana Sitesi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
    h1 { color: #1a73e8; }
    button { padding: 10px 15px; margin-bottom: 20px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Malik Paneli</h1>
  <p>Kendi ödeme kayıtlarınız ve site genel gelir-gider bilgileri burada gösterilecek.</p>
  <button id="logoutBtn">Çıkış Yap</button>
  <div>
    <h2>Ödeme Kayıtları</h2>
    <table border="1" cellpadding="8" cellspacing="0" id="paymentsTable"></table>
  </div>
  <div style="margin-top:40px;">
    <h2>Site Genel Gelir-Gider</h2>
    <pre id="generalFinance"></pre>
  </div>

  <script>
    const userEmail = localStorage.getItem("userEmail");
    if (!userEmail) {
      alert("Lütfen önce giriş yapınız.");
      window.location.href = "giris.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("userEmail");
      window.location.href = "giris.html";
    });

    async function fetchPayments() {
      // Buraya senin Google Apps Script API linkini yapıştır
      const apiURL = "https://script.google.com/macros/s/AKfycbweq8coY48LrL1TlZrpr4Aqn3eqNUS30mj6d7cgFxePYVCoCAmWyEtHzCRJ5RZSoT0/exec";

      try {
        const res = await fetch(apiURL);
        if (!res.ok) throw new Error("Veri alınamadı: " + res.statusText);
        const data = await res.json();

        // Sadece userEmail ile eşleşen kayıtlar filtreleniyor
        return data.filter(row => row.MALIK_EMAIL === userEmail);
      } catch (err) {
        alert("Ödeme kayıtları yüklenirken hata: " + err.message);
        return [];
      }
    }

    async function fetchGeneralFinance() {
      // Genel gelir-gider bilgisini çek (burayı kendi API'ne göre ayarla)
      const apiURL = "https://script.google.com/macros/s/AKfycbweq8coY48LrL1TlZrpr4Aqn3eqNUS30mj6d7cgFxePYVCoCAmWyEtHzCRJ5RZSoT0/exec";

      try {
        const res = await fetch(apiURL);
        if (!res.ok) throw new Error("Genel finans verisi alınamadı: " + res.statusText);
        const data = await res.json();

        // Burada site geneli gelir-gider özetini istediğin formatta işleyebilirsin
        // Örnek olarak tüm veriyi JSON formatında gösteriyoruz
        return data;
      } catch (err) {
        alert("Genel finans verisi yüklenirken hata: " + err.message);
        return null;
      }
    }

    function renderPayments(payments) {
      const table = document.getElementById("paymentsTable");
      table.innerHTML = "";
      if (payments.length === 0) {
        table.innerHTML = "<tr><td colspan='5'>Ödeme kaydı bulunamadı.</td></tr>";
        return;
      }

      // Tablo başlığı
      const headers = Object.keys(payments[0]);
      let thead = "<tr>";
      headers.forEach(h => {
        thead += `<th>${h}</th>`;
      });
      thead += "</tr>";
      table.innerHTML = thead;

      // Satırları ekle
      payments.forEach(payment => {
        let row = "<tr>";
        headers.forEach(h => {
          row += `<td>${payment[h]}</td>`;
        });
        row += "</tr>";
        table.innerHTML += row;
      });
    }

    async function renderPage() {
      const payments = await fetchPayments();
      renderPayments(payments);

      const generalFinance = await fetchGeneralFinance();
      document.getElementById("generalFinance").textContent = JSON.stringify(generalFinance, null, 2);
    }

    renderPage();
  </script>
</body>
</html>
