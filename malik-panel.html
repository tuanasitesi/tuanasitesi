<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Malik Paneli - Tuana Sitesi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
    h1 { color: #1a73e8; }
    button { padding: 8px 15px; font-size: 16px; cursor: pointer; margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #1a73e8; color: white; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Malik Paneli</h1>
  <p>Kendi ödeme kayıtlarınız ve site genel gelir-gider bilgileri burada gösterilecek.</p>
  <button id="logoutBtn">Çıkış Yap</button>

  <h2>Ödeme Kayıtları</h2>
  <div id="paymentSection">Yükleniyor...</div>

  <h2>Site Genel Gelir-Gider</h2>
  <div id="siteSummarySection">Yükleniyor...</div>

  <script>
    // Apps Script URL
    const DATA_URL = 'https://script.google.com/macros/s/AKfycbweq8coY48LrL1TlZrpr4Aqn3eqNUS30mj6d7cgFxePYVCoCAmWyEtHzCRJ5RZSoT0/exec';

    // Kullanıcının email'i girişten veya localStorage'dan alınmalı (örnek için sabit verdim)
    const loggedInUserEmail = localStorage.getItem('userEmail') || 'malik@example.com';

    // Çıkış butonu işlevi
    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem('userEmail');
      window.location.href = 'giris.html';
    };

    // Verileri çek ve işleyip ekrana yazdır
    async function loadPayments() {
      try {
        const res = await fetch(DATA_URL);
        if (!res.ok) throw new Error('Veri alınamadı: ' + res.statusText);
        const data = await res.json();

        // Ödeme kayıtlarını filtrele: sadece login kullanıcısının ödemeleri
        const userPayments = data.filter(row => row.MALİK && row.MALİK.toLowerCase() === loggedInUserEmail.toLowerCase());

        if (userPayments.length === 0) {
          document.getElementById('paymentSection').innerHTML = '<p>Hiç ödeme kaydı bulunamadı.</p>';
        } else {
          let html = '<table><thead><tr>';
          // Tablo başlıkları: AİDAT TAKİP 2024-2025 sayfasındaki sütun adlarını kullanıyoruz
          const headers = Object.keys(userPayments[0]);
          headers.forEach(h => { html += `<th>${h}</th>`; });
          html += '</tr></thead><tbody>';
          userPayments.forEach(row => {
            html += '<tr>';
            headers.forEach(h => { html += `<td>${row[h]}</td>`; });
            html += '</tr>';
          });
          html += '</tbody></table>';
          document.getElementById('paymentSection').innerHTML = html;
        }

        // Site genel gelir-gider hesaplama ve gösterme
        const siteSummary = {
          toplamGelir: 0,
          toplamGider: 0
        };
        data.forEach(row => {
          Object.entries(row).forEach(([key, value]) => {
            if (typeof value === 'string') {
              // Türkçe format veya ? işaretleri olabilir, sayıya çevir
              const num = Number(value.replace(/[^\d.-]/g, '')) || 0;
              if (/ödenen/i.test(key) || /gelir/i.test(key)) siteSummary.toplamGelir += num;
              else if (/gider/i.test(key)) siteSummary.toplamGider += num;
            }
          });
        });

        document.getElementById('siteSummarySection').innerHTML = `
          <p><strong>Toplam Gelir:</strong> ${siteSummary.toplamGelir.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</p>
          <p><strong>Toplam Gider:</strong> ${siteSummary.toplamGider.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</p>
        `;

      } catch (error) {
        document.getElementById('paymentSection').innerHTML = `<p class="error">Ödeme kayıtları yüklenirken hata: ${error.message}</p>`;
        document.getElementById('siteSummarySection').innerHTML = `<p class="error">Site genel gelir-gider bilgisi yüklenirken hata: ${error.message}</p>`;
      }
    }

    // Sayfa yüklendiğinde verileri yükle
    window.onload = loadPayments;
  </script>
</body>
</html>
